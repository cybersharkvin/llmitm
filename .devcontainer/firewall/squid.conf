# =============================================================================
# SQUID PROXY CONFIGURATION - LLMitM Firewall Sidecar
# =============================================================================
# This proxy controls all HTTP/HTTPS egress from the llmitm agent container.
# Only domains in the allowlist can be accessed.
# =============================================================================

# Port configuration
http_port 3128

# ACL definitions
acl localnet src 172.28.0.0/24    # Internal Docker network

# SSL/TLS handling - CONNECT method for HTTPS
acl SSL_ports port 443
acl Safe_ports port 80            # HTTP
acl Safe_ports port 443           # HTTPS
acl Safe_ports port 8080          # Alternative HTTP
acl CONNECT method CONNECT

# Allowlist file (populated by entrypoint.sh)
acl allowlist dstdomain "/etc/squid/allowlist.txt"

# =============================================================================
# ACCESS RULES (order matters!)
# =============================================================================

# Deny non-safe ports
http_access deny !Safe_ports

# Deny CONNECT to non-SSL ports
http_access deny CONNECT !SSL_ports

# Allow localhost
http_access allow localhost

# Allow internal network to access allowlisted domains only
http_access allow localnet allowlist

# Deny everything else
http_access deny all

# =============================================================================
# LOGGING
# =============================================================================

# Log blocked requests for debugging
access_log /var/log/squid/access.log
cache_log /var/log/squid/cache.log

# Log format showing allowed/denied
logformat llmitm %ts.%03tu %6tr %>a %Ss/%03>Hs %<st %rm %ru %[un %Sh/%<a %mt
# Log to file instead of stdout (squid user needs write permission)
access_log /dev/null llmitm

# =============================================================================
# PERFORMANCE
# =============================================================================

# Minimal caching (we're a firewall, not a cache)
cache deny all

# DNS
dns_nameservers 8.8.8.8 8.8.4.4

# Timeouts
connect_timeout 30 seconds
read_timeout 30 seconds

# Hide version
httpd_suppress_version_string on

# =============================================================================
# SECURITY
# =============================================================================

# Don't forward internal headers
via off
forwarded_for delete
